name: Build Egern Rules

on:
  workflow_dispatch:
  schedule:
    - cron: '30 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate Egern Rules
        run: |
          set +e

          mkdir -p Egern/Rule || true

          OUTPUT_DIR="$(pwd)/Egern/Rule"

          RULES=(
            "Telegram https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Telegram/Telegram.list"
            "Alibaba https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Alibaba/Alibaba.list"
            "ByteDance https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/ByteDance/ByteDance.list"
            "Tencent https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Tencent/Tencent.list"
            "YouTube https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/YouTube/YouTube.list"
            "Twitter https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Twitter/Twitter.list"
            "TikTok https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/TikTok/TikTok.list"
            "Github https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/GitHub/GitHub.list"
            "Google https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Google/Google.list"
            "Spotify https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Spotify/Spotify.list"
            "Netflix https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Netflix/Netflix.list"
            "ChinaIPs https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/ChinaIPs/ChinaIPs.list"
            "BanAD https://anti-ad.net/surge.txt https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Surge-RULE-SET.list https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/reject.txt"
            "China https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/ChinaMax/ChinaMax.list"
            "GFWList https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/gfw.txt https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyGFWlist.list"
            "Apple https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Ruleset/Apple.list https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Ruleset/AppleNews.list"
            "Meta https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Facebook/Facebook.list https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Instagram/Instagram.list https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Threads/Threads.list"
            "HttpDns https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/BlockHttpDNS/BlockHttpDNS.list"
            "AI https://gist.githubusercontent.com/ddgksf2013/cb4121e8b5c5d865cc949cb8120320c4/raw/Ai.yaml"
          )

          declare -A RULE_MAP=(
            [DOMAIN]=domain_set [DOMAIN-KEYWORD]=domain_keyword_set [DOMAIN-SUFFIX]=domain_suffix_set
            [DOMAIN-WILDCARD]=domain_wildcard_set [GEOIP]=geoip_set [IP-CIDR]=ip_cidr_set
            [IP-CIDR6]=ip_cidr6_set [URL-REGEX]=url_regex_set [USER-AGENT]=user_agent_set
            [IP-ASN]=asn_set [DEST-PORT]=dest_port_set
          )

          ORDERED_RULE_TYPES=(DOMAIN DOMAIN-KEYWORD DOMAIN-SUFFIX DOMAIN-WILDCARD GEOIP IP-CIDR IP-CIDR6 URL-REGEX USER-AGENT IP-ASN DEST-PORT)

          for group in "${RULES[@]}"; do
            read -r name urls <<< "$group"
            merged=$(mktemp)
            downloaded=false
            for url in $urls; do
              if curl -sL -f "$url" >> "$merged" 2>/dev/null; then
                downloaded=true
                echo "" >> "$merged"
              fi
            done

            if [ "$downloaded" != "true" ]; then
              echo "下载失败: $name - 所有 URL 均无法获取"
              rm -f "$merged"
              continue
            fi

            headers=$(grep '^#' "$merged" || true)
            update_time_raw=$(echo "$headers" | grep -i -E 'updated|update time|UPDATED|Update time' | head -1 | sed 's/.*: *//; s/[^0-9- :UTC+0-9]*//g' || true)

            if [ -z "$update_time_raw" ]; then
              update_time="$(date '+%Y-%m-%d %H:%M:%S')"
            else
              update_time="$update_time_raw"
            fi

            sorted=$(sort -u "$merged" | grep -v '^$' || true)
            rm -f "$merged"

            output="$OUTPUT_DIR/$name.yaml"

            rules=$(echo "$sorted" | grep -E '^[- ]*(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|DOMAIN-WILDCARD|IP-CIDR|IP-CIDR6|IP-ASN|URL-REGEX|DEST-PORT|GEOIP|USER-AGENT),' | sed 's/,no-resolve$//' || true)

            if [ -z "$rules" ]; then
              echo "无有效规则: $name - 跳过生成"
              continue
            fi

            no_resolve=$(echo "$sorted" | grep -qE '^[- ]*(IP-(ASN|CIDR|CIDR6)),.*,no-resolve$' && echo true || echo false)

            rule_count=$(echo "$rules" | wc -l | xargs)

            {
              echo "# 规则名称: $name"
              echo "# 规则统计: $rule_count 条"
              echo "# 更新时间: $update_time"
              echo ""
              [ "$no_resolve" = true ] && echo "no_resolve: true" && echo ""

              for type in "${ORDERED_RULE_TYPES[@]}"; do
                etype=${RULE_MAP[$type]}
                trules=$(echo "$rules" | grep "^[- ]*$type," || true)
                [ -z "$trules" ] && continue
                echo "$etype:"
                echo "$trules" | awk -F',' -v rt="$type" '{
                  v=$2
                  if (rt=="URL-REGEX" || rt=="DOMAIN-WILDCARD") v="\"" v "\""
                  else if (rt=="IP-ASN" || (rt=="USER-AGENT" && v~/^\*.*\*$/)) v="'"'"'" v "'"'"'"
                  print v
                }' | sort -u | sed 's/^/  - /'
                echo ""
              done
            } > "$output" || echo "写入 $output 失败，但继续"

            echo "生成: $name.yaml (更新时间: $update_time, 规则数: $rule_count)"

          done

      - name: Commit Changes if Any
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          HAS_CHANGES=false

          for yaml in Egern/Rule/*.yaml; do
            [ -f "$yaml" ] || continue
            NEW=$(sed '/^#/d;/^$/d' "$yaml" | sort || true)
            if git cat-file -e HEAD:"$yaml" 2>/dev/null; then
              OLD=$(git show HEAD:"$yaml" | sed '/^#/d;/^$/d' | sort || true)
            else
              OLD=""
            fi
            if [ "$NEW" != "$OLD" ]; then
              git add "$yaml"
              HAS_CHANGES=true
              echo "检测到变更: $(basename "$yaml")"
            else
              echo "无变更: $(basename "$yaml")"
            fi
          done

          if [ "$HAS_CHANGES" = true ]; then
            echo "有规则更新，提交 commit"
            git commit -m "Egern Rules - Auto Update $(date '+%Y-%m-%d %H:%M')"
            git push
          else
            echo "所有规则与上次 commit 相同，无需更新提交"
          fi